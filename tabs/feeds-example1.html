<div>
  <p>This is an example of an api.js handling of a RESTful api call, expecting <span>apiurl/APIKEY/feed/9/articles/101</span> would result it get_feeds_id_articles_id for feed_id: 9 and article_id: 101 using the given APIKEY for validation, it also uses the httpMethod for get / post / put / delete etc.</p>
  <p>After building the request name it would then search in side /requests directory for a request of that name and return the result of calling that request.</p>
  <div class="code-example">
    <div class="code-header">
      <span>RESTful API Handler</span>
      <span class="code-language">NodeJS</span>
    </div>
    <div class="code-content">
      <pre><code class="language-javascript">/**
 * Main serverless function handler for REST API requests
 * Handles authentication, request parsing, and routing to specific request handlers
 */
exports.handler = async function (event) {
  let variables = {};
  
  // Normalize HTTP method from different serverless platforms (AWS Lambda, Netlify, etc.)
  if (!event.httpMethod) {
    event.httpMethod = event?.requestContext?.httpMethod?.method;
  }
  if (event.httpMethod === undefined) return 501;

  // Parse RESTful path into structured variables
  // Expected format: /api/{32-char-api-key}/{resource}/{id}/{nested-resource}/{nested-id}/...
  let splitPath = event.path?.split("/") || event.rawPath?.split("/");
  
  if (splitPath?.length > 0) {
    // Skip path segments until we find the 32-character API key
    while (splitPath.length && splitPath[0].length != 32) splitPath.shift();
    
    if (splitPath.length && splitPath[0].length == 32) {
      variables.apikey = splitPath[0];              // Extract API key from path
      variables.request = event.httpMethod;         // Start building request name with HTTP method
      
      // Parse remaining path segments into request name and ID variables
      // Pattern: /resource/id/nested-resource/nested-id becomes GET_resource_id_nested-resource_id
      let i;
      for (i = 1; i < splitPath.length; i++) {
        if ((i & 1) == 0) {
          // Even index = ID value, add "_id" to request name and create {resource}_id variable
          variables.request += "_id";
          variables[toLowerCaseSingular(splitPath[i - 1]) + "_id"] = isNaN(parseInt(splitPath[i]))
            ? splitPath[i]    // Keep as string if not a number
            : parseInt(splitPath[i]); // Convert to integer if numeric
        } else {
          // Odd index = resource name, add to request name
          variables.request += "_" + splitPath[i];
        }
      }

      variables.request = variables.request.toLowerCase();
    }
  }

  // Merge query string parameters into variables object
  if (event.queryStringParameters) {
    if (event.queryStringParameters.variables) {
      // Special handling for JSON-encoded variables parameter
      Object.assign(variables, JSON.parse(event.queryStringParameters.variables));
    } else {
      // Direct merge of all query parameters
      Object.assign(variables, event.queryStringParameters);
    }
  }

  // Merge request body (JSON) into variables object
  if (event.body) {
    let jsonBody = JSON.parse(event.body);
    if (jsonBody) {
      Object.assign(variables, jsonBody);
    }
  }

  // Convert numeric strings to actual numbers for easier processing
  Object.keys(variables).forEach((key) => {
    if (typeof variables[key] === "string" && variables[key] !== "") {
      variables[key] = isNaN(variables[key])
        ? variables[key]           // Keep as string if not numeric
        : parseFloat(variables[key]); // Convert to number if numeric
    }
  });

  // Authenticate user (skip for sign-in requests)
  if (!["user_sign_in"].includes(variables.request)) {
    const authenticate = require("./authenticate");
    const authRes = await authenticate.handler(variables, db);
    console.log(authRes);
    
    if (authRes.statusCode != 200) {
      return authRes; // Return authentication error
    }
    variables.identityData = authRes.identityData; // Add user identity to variables
  }

  // Dynamically load and execute the appropriate request handler
  let request;
  try {
    // Load handler module based on parsed request name
    // e.g., "get_users_id" -> "./requests/get_users_id.js"
    request = require(`./requests/${variables.request}`);
  } catch (e) {
    console.log("could not find request", variables.request);
    return 501; // Not implemented - no handler found for this request type
  }

  // Execute the request handler with all parsed variables
  const requestResult = await request.handler(variables, db);
  return requestResult;
};
</code></pre>
    </div>
  </div>
</div>
